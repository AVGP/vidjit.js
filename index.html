<!DOCTYPE html>
<html>
    <head>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
        <script src="/lzw.js"></script>
        <script>
        var threshold = 1/16;
        
		function calcPartialAvg(arr, fromIndex, toIndex) {
			var sum = 0;
			var len = toIndex - fromIndex;
			for(var i=fromIndex; i<toIndex; i++) sum += arr[i];
			return sum / len;
		}
		
		function compressImgData(buffer) {
  	      var stringBuffer = "";
          for(var i=0, len = buffer.length; i < len; i+=4) {
          	for(var j=0;j<3;j++) { 
            	stringBuffer += String.fromCharCode(buffer[i + j]);
        	}
          }
     	  return LZW.compress(stringBuffer);
		}
		
        $("document").ready(function() {
            var youContext = $("#you")[0].getContext("2d");
            var otherContext = $("#other")[0].getContext("2d");
            var socket = io.connect();
            var video = $("#webcam")[0];
            var lastFrameAvgs = [0, 0, 0];
            var tLastKeyFrame = 0;
            var nSegments = 3;
            var segmentLength = 160000; // each segment has 100 lines -> 400 * 4 * 100

            var videoCallback = function() {
    //        	var start = new Date().getTime();
                youContext.drawImage(video, 0, 0, 400, 300);
                var imgData = youContext.getImageData(0, 0, 400, 300);
               	for(var i=0; i<nSegments;i++) {
               		var avg = calcPartialAvg(imgData.data, i * segmentLength, (i+1) * segmentLength);

               		if(Math.abs(avg-lastFrameAvgs[i]) > threshold) {
                		socket.emit("imgData", { 
		         			part: i, img: compressImgData(youContext.getImageData(0,100 * i, 400, 100).data)
       		       		});
                	}
	                lastFrameAvgs[i] = avg;                	
                }
                
                setTimeout(videoCallback, 50);
//                console.log("ENC took: " + ((new Date().getTime() - start)/1000));
            };

            socket.on('imgData', function (data) {
  //          	var start = new Date().getTime();
				var uncompressed = LZW.decompress(data.img);
				var imgData = otherContext.getImageData(0,0,400,300);
				var realOffset = data.part * segmentLength;
                for(var i=0, len = uncompressed.length; i < len; i += 3) {
                	imgData.data[realOffset] = uncompressed.charCodeAt(i);
                	imgData.data[realOffset+1] = uncompressed.charCodeAt(i+1);
                	imgData.data[realOffset+2] = uncompressed.charCodeAt(i+2);
                	imgData.data[realOffset+3] = 0xff;
                	realOffset += 4;
                }
                otherContext.putImageData(imgData, 0, 0);
	            	
//                console.log("DEC took: " + ((new Date().getTime() - start) / 1000));
            });

            //Get Webcam access
            window.navigator.webkitGetUserMedia({audio: true, video: true}, function(stream) {
                video.src = window.webkitURL.createObjectURL(stream);
                videoCallback();
            });
        });
        </script>
    </head>
    <body>
        <div>
            <video id="webcam" style="display:none;" width="400" height="300" autoplay></video>
            <canvas id="you" width="400" height="300"></canvas>
            <canvas id="other" width="400" height="300"></canvas>
        </div>
    </body>
</html>